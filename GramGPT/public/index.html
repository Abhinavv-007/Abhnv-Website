<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GramGPT</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-up': 'fadeUp 0.6s ease-out forwards',
                        'scale-in': 'scaleIn 0.5s ease-out forwards',
                        'glow-pulse': 'glowPulse 2s ease-in-out infinite',
                        'orb-drift': 'orbDrift 20s ease-in-out infinite',
                        'slide-in-right': 'slideInRight 0.4s ease-out forwards',
                        'bounce-subtle': 'bounceSubtle 2s ease-in-out infinite',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Custom Animations */
        @keyframes fadeUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes glowPulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4), 0 0 40px rgba(16, 185, 129, 0.2);
            }
            50% { 
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6), 0 0 60px rgba(16, 185, 129, 0.3);
            }
        }

        @keyframes orbDrift {
            0%, 100% { 
                transform: translate(0, 0) scale(1); 
            }
            25% { 
                transform: translate(100px, -100px) scale(1.1); 
            }
            50% { 
                transform: translate(-50px, -150px) scale(0.9); 
            }
            75% { 
                transform: translate(-150px, 50px) scale(1.05); 
            }
        }

        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes bounceSubtle {
            0%, 100% { 
                transform: translateY(0); 
            }
            50% { 
                transform: translateY(-10px); 
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        /* Glassmorphism utilities */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Animated gradient background */
        .animated-gradient {
            background: linear-gradient(
                135deg,
                #667eea 0%,
                #764ba2 25%,
                #f093fb 50%,
                #4facfe 75%,
                #00f2fe 100%
            );
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating orbs */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.6;
            animation: orbDrift 20s ease-in-out infinite;
            pointer-events: none;
        }

        /* Hover glow effect */
        .hover-glow {
            transition: all 0.3s ease;
        }

        .hover-glow:hover {
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        /* 3D tilt effect */
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }

        .card-3d:hover {
            transform: perspective(1000px) rotateX(2deg) rotateY(5deg) translateY(-5px);
        }

        /* Message bubble animations */
        @keyframes messageBounce {
            0% { 
                opacity: 0; 
                transform: scale(0.8) translateY(20px); 
            }
            60% { 
                transform: scale(1.02) translateY(-2px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .message-enter {
            animation: messageBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Typing indicator glow */
        .typing-dot {
            animation: typingGlow 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingGlow {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Scroll shadow */
        .scroll-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Focus ring improvement */
        .focus-ring:focus {
            outline: none;
            ring: 2px;
            ring-offset: 2px;
            ring-color: #10b981;
        }

        /* Reduce motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.7);
        }

        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.4);
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.6);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-emerald-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 transition-colors duration-500">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const LANGUAGES = {
          'en-IN': 'English',
          'hi-IN': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)',
          'bn-IN': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)',
          'mr-IN': '‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)',
          'ta-IN': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)',
          'te-IN': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)',
          'gu-IN': '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)',
        };

        const CATEGORIES = {
            'en-IN': [
                { title: 'üè¶ Government Schemes' },
                { title: 'üåø Agriculture Help' },
                { title: '‚öñÔ∏è Legal Rights' },
                { title: 'üíº Job Opportunities' },
                { title: 'üå¶Ô∏è Weather Advisory' },
                { title: 'üêõ Pest & Disease Help' },
                { title: 'üìÑ Document Guide' },
                { title: 'üå± Fertilizer Calculator' }
            ],
            'hi-IN': [
                { title: 'üè¶ ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç' },
                { title: 'üåø ‡§ï‡•É‡§∑‡§ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ' },
                { title: '‚öñÔ∏è ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞' },
                { title: 'üíº ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ï‡•á ‡§Ö‡§µ‡§∏‡§∞' },
                { title: 'üå¶Ô∏è ‡§Æ‡•å‡§∏‡§Æ ‡§∏‡§≤‡§æ‡§π' },
                { title: 'üêõ ‡§ï‡•Ä‡§ü ‡§è‡§µ‡§Ç ‡§∞‡•ã‡§ó ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ' },
                { title: 'üìÑ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ' },
                { title: 'üå± ‡§â‡§∞‡•ç‡§µ‡§∞‡§ï ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞' }
            ],
        };

        // --- Components ---

        const Header = ({ theme, setTheme, language, setLanguage, onHomeClick }) => {
            const [scrolled, setScrolled] = useState(false);

            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            };

            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
            }, [theme]);

            useEffect(() => {
                const handleScroll = () => {
                    setScrolled(window.scrollY > 20);
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            return (
                <header className={`sticky top-0 z-50 transition-all duration-300 ${
                    scrolled 
                        ? 'bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl shadow-lg border-b border-emerald-100/20 dark:border-emerald-500/10' 
                        : 'bg-white/50 dark:bg-slate-900/50 backdrop-blur-md'
                }`}>
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                        <h1 
                            onClick={onHomeClick} 
                            className="text-2xl sm:text-3xl font-bold cursor-pointer select-none transition-all duration-300 hover:scale-105 flex items-center gap-2"
                        >
                            <span className="text-slate-800 dark:text-white">Gram</span>
                            <span className="gradient-text">GPT</span>
                            <span className="text-2xl animate-bounce-subtle">‚ú®</span>
                        </h1>
                        <div className="flex items-center space-x-2 sm:space-x-4">
                            <select
                                value={language}
                                onChange={(e) => setLanguage(e.target.value)}
                                className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-2 border-emerald-200 dark:border-emerald-500/30 rounded-xl px-3 py-2 text-sm sm:text-base text-slate-800 dark:text-white font-medium shadow-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all duration-300 hover:border-emerald-400 dark:hover:border-emerald-400"
                            >
                                {Object.entries(LANGUAGES).map(([code, name]) => (
                                    <option key={code} value={code}>{name}</option>
                                ))}
                            </select>
                            <button 
                                onClick={toggleTheme} 
                                className="p-2.5 sm:p-3 rounded-xl bg-gradient-to-br from-emerald-400 to-teal-500 text-white hover:from-emerald-500 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all duration-300 shadow-lg hover:shadow-emerald-500/50 hover:scale-110"
                                aria-label="Toggle theme"
                            >
                                {theme === 'light' ? (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                                ) : (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                )}
                            </button>
                        </div>
                    </div>
                </header>
            );
        };
        
        const Footer = () => (
            <footer className="mt-auto border-t border-slate-200/50 dark:border-slate-800/50 bg-white/30 dark:bg-slate-900/30 backdrop-blur-sm">
                <div className="max-w-7xl mx-auto px-4 py-6 flex flex-col items-center space-y-3">
                    <p className="text-sm font-medium text-slate-600 dark:text-slate-400">
                        Built with <span className="text-red-500 animate-pulse">‚ù§Ô∏è</span> by Abhinav
                    </p>
                    <a 
                        href="https://www.linkedin.com/in/abhnv07" 
                        target="_blank" 
                        rel="noopener noreferrer" 
                        aria-label="Abhinav's LinkedIn Profile"
                        className="group"
                    >
                        <svg 
                            xmlns="http://www.w3.org/2000/svg" 
                            className="h-7 w-7 text-slate-500 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-all duration-300 group-hover:scale-110" 
                            fill="currentColor" 
                            viewBox="0 0 24 24"
                        >
                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                        </svg>
                    </a>
                </div>
            </footer>
        );

        const FloatingOrbs = () => {
            const [isVisible, setIsVisible] = useState(true);

            useEffect(() => {
                const handleVisibilityChange = () => {
                    setIsVisible(!document.hidden);
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, []);

            if (!isVisible) return null;

            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    <div className="orb w-96 h-96 bg-gradient-to-r from-emerald-400 to-teal-500 top-10 -left-20" style={{ animationDelay: '0s' }} />
                    <div className="orb w-80 h-80 bg-gradient-to-r from-blue-400 to-purple-500 top-1/3 right-10" style={{ animationDelay: '5s' }} />
                    <div className="orb w-72 h-72 bg-gradient-to-r from-pink-400 to-rose-500 bottom-20 left-1/4" style={{ animationDelay: '10s' }} />
                </div>
            );
        };

        const CategoryCard = ({ title, onClick, delay }) => {
            const emoji = title.split(' ')[0];
            const text = title.split(' ').slice(1).join(' ');

            return (
                <div
                    onClick={onClick}
                    className="card-3d hover-glow group relative bg-white/60 dark:bg-slate-800/60 backdrop-blur-xl rounded-2xl shadow-xl p-6 sm:p-8 flex flex-col items-center justify-center text-center cursor-pointer border border-emerald-200/30 dark:border-emerald-500/20 opacity-0 animate-fade-up overflow-hidden"
                    style={{ animationDelay: `${delay}ms` }}
                >
                    <div className="absolute inset-0 bg-gradient-to-br from-emerald-400/0 via-teal-400/0 to-blue-400/0 group-hover:from-emerald-400/10 group-hover:via-teal-400/10 group-hover:to-blue-400/10 transition-all duration-500 rounded-2xl" />
                    <div className="relative z-10 text-5xl sm:text-6xl mb-4 transition-transform duration-300 group-hover:scale-125 group-hover:rotate-12 filter drop-shadow-lg">
                        {emoji}
                    </div>
                    <h3 className="relative z-10 text-base sm:text-lg font-bold text-slate-800 dark:text-white group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors duration-300">
                        {text}
                    </h3>
                    <div className="absolute -bottom-2 -right-2 w-20 h-20 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full blur-2xl opacity-0 group-hover:opacity-30 transition-opacity duration-500" />
                </div>
            );
        };

        const HomePage = ({ onCategorySelect, language }) => {
            const currentCategories = CATEGORIES[language] || CATEGORIES['en-IN'];
            
            return (
                <div className="relative min-h-[calc(100vh-200px)]">
                    <FloatingOrbs />
                    
                    {/* Hero Section */}
                    <div className="relative z-10 text-center pt-12 sm:pt-20 pb-16 px-4">
                        <div className="max-w-4xl mx-auto space-y-6">
                            <h2 className="text-4xl sm:text-6xl lg:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 via-teal-500 to-blue-600 dark:from-emerald-400 dark:via-teal-400 dark:to-blue-400 opacity-0 animate-scale-in mb-4" style={{ animationDelay: '100ms' }}>
                                Welcome to GramGPT! üöÄ
                            </h2>
                            <p className="text-lg sm:text-xl lg:text-2xl text-slate-700 dark:text-slate-300 font-medium opacity-0 animate-fade-up leading-relaxed max-w-3xl mx-auto" style={{ animationDelay: '300ms' }}>
                                Your intelligent AI assistant for rural India. 
                                <br />
                                <span className="text-emerald-600 dark:text-emerald-400 font-semibold">Get instant, reliable information in your own language.</span>
                            </p>
                            <div className="flex flex-wrap justify-center gap-4 opacity-0 animate-fade-up" style={{ animationDelay: '500ms' }}>
                                <div className="flex items-center gap-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg border border-emerald-200/50 dark:border-emerald-500/30">
                                    <span className="text-2xl">üåç</span>
                                    <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">Multi-Language</span>
                                </div>
                                <div className="flex items-center gap-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg border border-emerald-200/50 dark:border-emerald-500/30">
                                    <span className="text-2xl">üé§</span>
                                    <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">Voice Enabled</span>
                                </div>
                                <div className="flex items-center gap-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg border border-emerald-200/50 dark:border-emerald-500/30">
                                    <span className="text-2xl">‚ö°</span>
                                    <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">AI Powered</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Categories Grid */}
                    <div className="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
                        <h3 className="text-2xl sm:text-3xl font-bold text-center text-slate-800 dark:text-white mb-10 opacity-0 animate-fade-up" style={{ animationDelay: '600ms' }}>
                            Select a Category to Begin
                        </h3>
                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
                            {currentCategories.map((cat, index) => (
                                <CategoryCard 
                                    key={cat.title} 
                                    title={cat.title} 
                                    onClick={() => onCategorySelect(cat.title)} 
                                    delay={700 + index * 80} 
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const TypingIndicator = () => (
            <div className="flex items-end gap-2 message-enter">
                <div className="flex items-center justify-center space-x-2 px-6 py-4 rounded-3xl bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl shadow-xl border border-emerald-200/30 dark:border-emerald-500/20 rounded-bl-md">
                    <div className="typing-dot w-3 h-3 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-full shadow-lg" />
                    <div className="typing-dot w-3 h-3 bg-gradient-to-r from-teal-400 to-blue-500 rounded-full shadow-lg" />
                    <div className="typing-dot w-3 h-3 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full shadow-lg" />
                </div>
            </div>
        );

        const parseSimpleMarkdown = (text = '') => {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-emerald-700 dark:text-emerald-300">$1</strong>');
            html = html.replace(/(?<!\*)\*(.*?)\*(?!\*)/g, '<em class="italic">$1</em>');
            return html;
        };

        const Message = ({ message, onSpeak, onCopy, onSummarize }) => {
            const isUser = message.role === 'user';
            const plainTextForSpeechAndCopy = message.text.replace(/\*\*/g, '').replace(/\*/g, '');

            return (
                <div className={`group flex items-end gap-3 message-enter ${isUser ? 'justify-end' : 'justify-start'}`}>
                    {!isUser && (
                        <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white font-bold shadow-lg">
                            AI
                        </div>
                    )}
                    <div className={`max-w-xs sm:max-w-md lg:max-w-2xl px-5 py-4 rounded-3xl shadow-xl backdrop-blur-xl border transition-all duration-300 ${
                        isUser 
                            ? 'bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-br-md border-emerald-400/50' 
                            : 'bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-slate-100 rounded-bl-md border-slate-200/50 dark:border-slate-700/50'
                    }`}>
                        <div
                            className="whitespace-pre-wrap leading-relaxed"
                            dangerouslySetInnerHTML={{ __html: parseSimpleMarkdown(message.text) }}
                        />
                    </div>
                    {!isUser && (
                        <div className="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                            <button
                                onClick={() => onSpeak(plainTextForSpeechAndCopy)}
                                className="p-2 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-emerald-600 dark:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 focus:outline-none shadow-lg hover:shadow-emerald-500/30 transition-all duration-300 hover:scale-110 border border-emerald-200/50 dark:border-emerald-500/30"
                                aria-label="Read message aloud"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 17.142a5.001 5.001 0 010-7.072m2.828 9.9a9 9 0 010-12.728M12 12h.01" /></svg>
                            </button>
                            <button
                                onClick={() => onCopy(plainTextForSpeechAndCopy)}
                                className="p-2 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 focus:outline-none shadow-lg hover:shadow-blue-500/30 transition-all duration-300 hover:scale-110 border border-blue-200/50 dark:border-blue-500/30"
                                aria-label="Copy message"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                            <button
                                onClick={() => onSummarize(message.text)}
                                className="p-2 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/30 focus:outline-none shadow-lg hover:shadow-purple-500/30 transition-all duration-300 hover:scale-110 border border-purple-200/50 dark:border-purple-500/30"
                                aria-label="Summarize message"
                            >
                                <span className="font-bold text-lg">‚ú®</span>
                            </button>
                        </div>
                    )}
                    {isUser && (
                        <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg">
                            U
                        </div>
                    )}
                </div>
            );
        };
        
        const Toast = ({ message, show, onDismiss }) => {
            if (!show) return null;

            useEffect(() => {
                const timer = setTimeout(() => {
                    onDismiss();
                }, 3000);
                return () => clearTimeout(timer);
            }, [show, onDismiss]);

            return (
                <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-scale-in">
                    <div className="bg-slate-900/95 dark:bg-white/95 backdrop-blur-xl text-white dark:text-slate-900 py-3 px-6 rounded-2xl shadow-2xl border border-emerald-500/30 flex items-center gap-3">
                        <span className="text-2xl">‚úÖ</span>
                        <span className="font-medium">{message}</span>
                    </div>
                </div>
            );
        };

        const ChatWindow = ({ messages, onSendMessage, language, onSpeak, isLoading, onClearChat, onCopy, onSummarize, onGetSuggestions, suggestions, showToast }) => {
            const [input, setInput] = useState('');
            const [isListening, setIsListening] = useState(false);
            const chatEndRef = useRef(null);
            const recognitionRef = useRef(null);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages, isLoading]);

            const handleSend = () => {
                if (input.trim()) {
                    onSendMessage(input.trim());
                    setInput('');
                }
            };

            const handleVoiceInput = useCallback(() => {
                if (isListening) {
                    recognitionRef.current?.stop();
                    setIsListening(false);
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    showToast("Sorry, your browser doesn't support speech recognition.");
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.lang = language;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognitionRef.current = recognition;

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    setIsListening(false);
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    setInput(prev => prev ? `${prev} ${speechResult}` : speechResult);
                };

                recognition.start();
            }, [isListening, language, showToast]);

            return (
                <div className="flex flex-col flex-grow relative">
                    {/* Chat Messages */}
                    <div className="flex-grow p-4 sm:p-6 space-y-6 overflow-y-auto">
                        {messages.length > 1 && (
                            <div className="flex justify-center sticky top-2 z-10">
                                <button 
                                    onClick={onClearChat}
                                    className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl text-sm font-semibold text-slate-700 dark:text-slate-300 py-2 px-5 rounded-full hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 transition-all duration-300 shadow-lg border border-slate-200/50 dark:border-slate-700/50 hover:border-red-300 dark:hover:border-red-500/50 hover:scale-105"
                                >
                                    üóëÔ∏è Clear Chat
                                </button>
                            </div>
                        )}
                        {messages.map((msg, index) => (
                            <Message key={index} message={msg} onSpeak={onSpeak} onCopy={onCopy} onSummarize={onSummarize} />
                        ))}
                        {isLoading && <TypingIndicator />}
                        {!isLoading && messages.length > 2 && (
                            <div className="flex justify-center animate-fade-up">
                                 <button 
                                    onClick={onGetSuggestions} 
                                    className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white text-sm font-bold py-3 px-6 rounded-2xl hover:from-emerald-600 hover:to-teal-700 transition-all duration-300 flex items-center gap-2 shadow-xl hover:shadow-emerald-500/50 hover:scale-105 border border-emerald-400/50"
                                 >
                                     <span className="text-xl">‚ú®</span>
                                     Smart Suggestions
                                 </button>
                            </div>
                        )}
                        {suggestions.length > 0 && (
                            <div className="flex flex-col items-center gap-3 py-2">
                                {suggestions.map((s, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => onSendMessage(s)} 
                                        className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl w-full max-w-2xl text-left p-4 rounded-2xl text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 hover:text-emerald-700 dark:hover:text-emerald-300 transition-all duration-300 shadow-lg border border-slate-200/50 dark:border-slate-700/50 hover:border-emerald-300 dark:hover:border-emerald-500/50 hover:scale-[1.02] opacity-0 animate-slide-in-right"
                                        style={{ animationDelay: `${i * 100}ms` }}
                                    >
                                        üí¨ {s}
                                    </button>
                                ))}
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    {/* Input Composer */}
                    <div className="sticky bottom-0 p-4 sm:p-6 bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl border-t border-slate-200/50 dark:border-slate-800/50">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex items-end space-x-3 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl rounded-3xl shadow-2xl p-3 border-2 border-emerald-200/50 dark:border-emerald-500/30 focus-within:border-emerald-400 dark:focus-within:border-emerald-400 transition-all duration-300">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())}
                                    placeholder="Type your message..."
                                    className="flex-grow p-3 bg-transparent text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none resize-none font-medium text-base"
                                    rows="1"
                                    style={{ maxHeight: '120px' }}
                                />
                                <button
                                    onClick={handleVoiceInput}
                                    className={`flex-shrink-0 p-3 sm:p-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all duration-300 shadow-lg hover:scale-110 ${
                                        isListening 
                                            ? 'bg-gradient-to-br from-red-500 to-pink-600 text-white animate-glow-pulse' 
                                            : 'bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-700 dark:to-slate-600 text-slate-700 dark:text-slate-300 hover:from-emerald-400 hover:to-teal-500 hover:text-white'
                                    }`}
                                    aria-label={isListening ? 'Stop listening' : 'Start voice input'}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 sm:h-7 sm:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                                </button>
                                <button
                                    onClick={handleSend}
                                    disabled={!input.trim()}
                                    className="flex-shrink-0 p-3 sm:p-4 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 text-white hover:from-emerald-600 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all duration-300 shadow-lg hover:shadow-emerald-500/50 hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                    aria-label="Send message"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 sm:h-7 sm:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
            const [language, setLanguage] = useState('en-IN');
            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [view, setView] = useState('home');
            const [suggestions, setSuggestions] = useState([]);
            const [toast, setToast] = useState({ show: false, message: '' });
            const chatHistoryRef = useRef([]);

            const getInitialMessage = () => ({
                role: 'model',
                text: 'Hello! I am GramGPT. I can help you with information on government schemes, farming, legal rights, and jobs. How can I assist you today?',
            });

            useEffect(() => {
                const initialBotMessage = getInitialMessage();
                setMessages([initialBotMessage]);
                chatHistoryRef.current = [
                    { role: 'user', parts: [{ text: "Initial Greeting" }] }, 
                    { role: 'model', parts: [{ text: initialBotMessage.text }] }
                ];
            }, []);
            
            const showToast = (message) => {
                setToast({ show: true, message });
            };

            const dismissToast = () => {
                setToast({ show: false, message: '' });
            };

            // 
            // THIS IS THE CORRECT, SINGLE FUNCTION
            //
            const handleCategorySelect = (categoryTitle) => {
                setView('chat');

                // Extract the plain text topic
                const topic = categoryTitle.split(' ').slice(1).join(' ');

                // 1. Generate the bot's new greeting based on language
                let greetingText = '';
                if (language === 'hi-IN') {
                    greetingText = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ${topic} ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§®‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?`;
                } else {
                    greetingText = `Hi! I can help you with ${topic}. What would you like to know?`;
                }

                // 2. Get the initial messages
                const initialBotMessage = getInitialMessage();
                const categoryGreetingMessage = { role: 'model', text: greetingText };

                // 3. Set what the user SEES in the chat window
                setMessages([initialBotMessage, categoryGreetingMessage]);
                
                // 4. Set the API chat history to be a VALID, alternating history
                chatHistoryRef.current = [
                    { role: 'user', parts: [{ text: "Initial Greeting" }] }, 
                    { role: 'model', parts: [{ text: initialBotMessage.text }] },
                    // This is the new, "virtual" user message that keeps the roles alternating
                    { role: 'user', parts: [{ text: `I have a question about ${topic}.` }] },
                    // This is the bot's response that the user sees
                    { role: 'model', parts: [{ text: categoryGreetingMessage.text }] }
                ];
            };
            
            const handleGoHome = () => {
                 setView('home');
            };

            const handleClearChat = () => {
                const initialBotMessage = getInitialMessage();
                setMessages([initialBotMessage]);
                setSuggestions([]);
                chatHistoryRef.current = [
                    { role: 'user', parts: [{ text: "Initial Greeting" }] }, 
                    { role: 'model', parts: [{ text: initialBotMessage.text }] }
                ];
            };

            const handleCopy = (textToCopy) => {
                 navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast("Copied to clipboard!");
                 }).catch(err => {
                     console.error('Failed to copy text: ', err);
                     showToast("Failed to copy.");
                 });
            };
            
            const callGemini = async (payload) => {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                }
                return response.json();
            };

            const handleSummarize = async (textToSummarize) => {
                setIsLoading(true);
                const selectedLanguageName = LANGUAGES[language];
                const prompt = `Please summarize the following text in about one or two simple sentences, in the ${selectedLanguageName} language:\n\n---\n\n${textToSummarize}`;
                
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.5 }
                    };
                    const result = await callGemini(payload);
                    const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";
                    const summaryMessage = { role: 'model', text: `**Summary:** ${summaryText}` };
                    setMessages(prev => [...prev, summaryMessage]);
                } catch (error) {
                    console.error("Summarize API call failed:", error);
                    const errorMessage = { role: 'model', text: `Sorry, I couldn't summarize that. Please try again.` };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleGetSuggestions = async () => {
                setIsLoading(true);
                setSuggestions([]);
                const selectedLanguageName = LANGUAGES[language];
                const conversationContext = chatHistoryRef.current.map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n');
                const prompt = `Based on this conversation, suggest three relevant, short follow-up questions a user might ask. The user is speaking ${selectedLanguageName}, so provide the suggestions in that language. Return ONLY a JSON array of strings, like ["question 1", "question 2", "question 3"].\n\nConversation:\n${conversationContext}`;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { 
                            temperature: 0.8,
                            responseMimeType: "application/json",
                         }
                    };
                    const result = await callGemini(payload);
                    const suggestionsArray = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "[]");
                    setSuggestions(suggestionsArray);
                } catch (error) {
                    console.error("Suggestions API call failed:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSendMessage = async (userInput, isFromCategory = false) => {
                if (isLoading) return;
                setSuggestions([]);

                const userMessage = { role: 'user', text: userInput };
                
                setMessages(prev => [...prev, userMessage]);
                setIsLoading(true);

                const selectedLanguageName = LANGUAGES[language];
                const systemPrompt = `You are "GramGPT", an expert AI assistant for rural India. Your primary goal is to provide clear, concise, and actionable information.
                The user is communicating in ${selectedLanguageName}.
                You MUST respond fluently and accurately in ${selectedLanguageName}.
                Your knowledge base includes: Indian government schemes, modern agricultural practices, legal rights, job opportunities, **common pest/disease diagnosis for crops**, **step-by-step guides for applying for government documents**, and **fertilizer calculation estimates based on crop and area**.
                Keep your answers simple, easy to understand for a non-technical audience, and use bullet points or numbered lists for clarity where possible. Use markdown for formatting, for example **bold** for important terms.
                When providing pest/disease advice or fertilizer calculations, **always include a disclaimer** to consult local authorities or experts for confirmation.
                If you don't know an answer, say so honestly in ${selectedLanguageName} and suggest where they might find the information.
                Do not mention that you are a language model. Just be the helpful assistant, GramGPT.`;

                chatHistoryRef.current.push({ role: 'user', parts: [{ text: userInput }] });

                const payload = {
                    contents: chatHistoryRef.current,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.7, topK: 40, topP: 0.95 }
                };

                try {
                    const result = await callGemini(payload);
                    
                    let botResponseText = "Sorry, I couldn't get a response. Please try again.";
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]?.text) {
                        botResponseText = result.candidates[0].content.parts[0].text;
                    }

                    chatHistoryRef.current.push({ role: 'model', parts: [{ text: botResponseText }] });
                    const botMessage = { role: 'model', text: botResponseText };
                    
                    setMessages(prev => [...prev, botMessage]);

                } catch (error) {
                    console.error("Failed to fetch from Gemini API:", error);
                    const errorMessage = { role: 'model', text: `Sorry, something went wrong. Please check your connection and try again.` };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSpeak = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = language;
                    const voices = window.speechSynthesis.getVoices();
                    utterance.voice = voices.find(voice => voice.lang === language) || voices.find(voice => voice.lang.startsWith(language.split('-')[0])) || null;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                } else {
                    showToast("Sorry, your browser doesn't support text-to-speech.");
                }
            };
            
            useEffect(() => {
                 if ('speechSynthesis' in window) {
                     window.speechSynthesis.onvoiceschanged = () => {
                         window.speechSynthesis.getVoices();
                     };
                 }
            }, []);

            return (
                <div className="min-h-screen flex flex-col">
                    <Header 
                        theme={theme} 
                        setTheme={setTheme} 
                        language={language} 
                        setLanguage={setLanguage}
                        onHomeClick={handleGoHome}
                    />
                    <main className="flex-grow flex flex-col">
                        {view === 'home' && <HomePage onCategorySelect={handleCategorySelect} language={language} />}
                        {view === 'chat' && (
                            <ChatWindow 
                                messages={messages}
                                onSendMessage={handleSendMessage}
                                language={language}
                                onSpeak={handleSpeak}
                                isLoading={isLoading}
                                onClearChat={handleClearChat}
                                onCopy={handleCopy}
                                onSummarize={handleSummarize}
                                onGetSuggestions={handleGetSuggestions}
                                suggestions={suggestions}
                                showToast={showToast}
                            />
                        )}
                    </main>
                    <Footer />
                    <Toast message={toast.message} show={toast.show} onDismiss={dismissToast} />
                </div>
            );
        }

        // 5. Render the App to the 'root' div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
