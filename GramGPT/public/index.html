<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GramGPT</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use the 'class' strategy for dark mode
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom animations */
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-in-out forwards;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.4s ease-out forwards;
        }
        /* Basic font styling */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="bg-gradient-to-br from-pink-50 via-blue-50 to-purple-50 dark:from-slate-900 dark:to-gray-900 transition-colors duration-500">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const LANGUAGES = {
          'en-IN': 'English',
          'hi-IN': 'à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)',
          'bn-IN': 'à¦¬à¦¾à¦‚à¦²à¦¾ (Bengali)',
          'mr-IN': 'à¤®à¤°à¤¾à¤ à¥€ (Marathi)',
          'ta-IN': 'à®¤à®®à®¿à®´à¯ (Tamil)',
          'te-IN': 'à°¤à±†à°²à±à°—à± (Telugu)',
          'gu-IN': 'àª—à«àªœàª°àª¾àª¤à«€ (Gujarati)',
        };

        // --- CHANGE 1: REMOVED THE UNUSED "prompt" PROPERTY ---
        const CATEGORIES = {
            'en-IN': [
                { title: 'ðŸ¦ Government Schemes' },
                { title: 'ðŸŒ¿ Agriculture Help' },
                { title: 'âš–ï¸ Legal Rights' },
                { title: 'ðŸ’¼ Job Opportunities' },
                { title: 'ðŸŒ¦ï¸ Weather Advisory' },
                { title: 'ðŸ› Pest & Disease Help' },
                { title: 'ðŸ“„ Document Guide' },
                { title: 'ðŸŒ± Fertilizer Calculator' }
            ],
            'hi-IN': [
                { title: 'ðŸ¦ à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤¯à¥‹à¤œà¤¨à¤¾à¤à¤‚' },
                { title: 'ðŸŒ¿ à¤•à¥ƒà¤·à¤¿ à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾' },
                { title: 'âš–ï¸ à¤•à¤¾à¤¨à¥‚à¤¨à¥€ à¤…à¤§à¤¿à¤•à¤¾à¤°' },
                { title: 'ðŸ’¼ à¤°à¥‹à¤œà¤—à¤¾à¤° à¤•à¥‡ à¤…à¤µà¤¸à¤°' },
                { title: 'ðŸŒ¦ï¸ à¤®à¥Œà¤¸à¤® à¤¸à¤²à¤¾à¤¹' },
                { title: 'ðŸ› à¤•à¥€à¤Ÿ à¤à¤µà¤‚ à¤°à¥‹à¤— à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾' },
                { title: 'ðŸ“„ à¤¦à¤¸à¥à¤¤à¤¾à¤µà¥‡à¤œà¤¼ à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾' },
                { title: 'ðŸŒ± à¤‰à¤°à¥à¤µà¤°à¤• à¤•à¥ˆà¤²à¤•à¥à¤²à¥‡à¤Ÿà¤°' }
            ],
        };

        // --- Components ---

        const Header = ({ theme, setTheme, language, setLanguage, onHomeClick }) => {
            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            };

            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
            }, [theme]);

            return (
                <header className="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center sticky top-0 z-20 transition-colors duration-300">
                    <h1 onClick={onHomeClick} className="text-2xl font-bold text-gray-800 dark:text-white cursor-pointer select-none transition-transform duration-300 hover:scale-105">
                        Gram<span className="text-green-500">GPT</span>
                    </h1>
                    <div className="flex items-center space-x-2 sm:space-x-4">
                        <select
                            value={language}
                            onChange={(e) => setLanguage(e.target.value)}
                            className="bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-sm sm:text-base text-gray-800 dark:text-white focus:ring-2 focus:ring-green-500 focus:outline-none transition-all duration-300"
                        >
                            {Object.entries(LANGUAGES).map(([code, name]) => (
                                <option key={code} value={code}>{name}</option>
                            ))}
                        </select>
                        <button onClick={toggleTheme} className="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-50 dark:focus:ring-offset-gray-900 focus:ring-green-500 transition-all duration-300">
                            {theme === 'light' ? (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                            ) : (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            )}
                        </button>
                    </div>
                </header>
            );
        };
        
        const Footer = () => (
            <footer className="text-center p-6 mt-auto text-sm text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-800 flex flex-col items-center space-y-2">
                <p>Built By Abhinav</p>
                <a href="https://www.linkedin.com/in/abhnv07" target="_blank" rel="noopener noreferrer" aria-label="Abhinav's LinkedIn Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-500 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                </a>
            </footer>
        );

        const CategoryCard = ({ title, onClick, delay }) => {
            const emoji = title.split(' ')[0];
            const text = title.split(' ').slice(1).join(' ');

            return (
                <div
                    onClick={onClick}
                    className="bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-xl shadow-lg p-4 sm:p-6 flex flex-col items-center justify-center text-center cursor-pointer transform hover:scale-105 hover:-translate-y-1 transition-all duration-300 ease-in-out hover:shadow-green-500/20 hover:shadow-2xl opacity-0 animate-fade-in"
                    style={{ animationDelay: `${delay}ms` }}
                >
                    <div className="text-4xl mb-4 transition-transform duration-300 group-hover:scale-110">{emoji}</div>
                    <h3 className="text-md sm:text-lg font-semibold text-gray-800 dark:text-white">{text}</h3>
                </div>
            );
        };

        const HomePage = ({ onCategorySelect, language }) => {
            const currentCategories = CATEGORIES[language] || CATEGORIES['en-IN'];
            return (
                <div className="p-4 sm:p-6 md:p-8">
                    <div className="text-center mb-10">
                        <h2 className="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-white animate-fade-in opacity-0" style={{ animationDelay: '100ms' }}>Welcome to GramGPT!</h2>
                        <p className="text-gray-600 dark:text-gray-300 mt-3 max-w-2xl mx-auto animate-fade-in opacity-0" style={{ animationDelay: '200ms' }}>Your friendly AI assistant for rural India. Get instant, reliable information in your own language. Select a category to begin.</p>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 sm:gap-6">
                        {currentCategories.map((cat, index) => (
                             // --- CHANGE 2: onClick NOW SENDS THE cat.title ---
                            <CategoryCard key={cat.title} title={cat.title} onClick={() => onCategorySelect(cat.title)} delay={300 + index * 100} />
                        ))}
                    </div>
                </div>
            );
        };

        const TypingIndicator = () => (
            <div className="flex items-end gap-2">
                <div className="flex items-center justify-center space-x-1.5 max-w-xs md:max-w-md lg:max-w-2xl px-4 py-3 rounded-2xl bg-gray-200 dark:bg-gray-700 rounded-bl-none">
                    <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style={{ animationDelay: '0s' }}></div>
                    <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                    <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></div>
                </div>
            </div>
        );

        const parseSimpleMarkdown = (text = '') => {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/(?<!\*)\*(.*?)\*(?!\*)/g, '<em>$1</em>');
            return html;
        };

        const Message = ({ message, onSpeak, onCopy, onSummarize }) => {
            const isUser = message.role === 'user';
            const plainTextForSpeechAndCopy = message.text.replace(/\*\*/g, '').replace(/\*/g, '');

            return (
                <div className={`group flex items-end gap-2 animate-fade-in-up ${isUser ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-xs md:max-w-md lg:max-w-2xl px-4 py-3 rounded-2xl shadow-md ${isUser ? 'bg-green-400 text-white rounded-br-none' : 'bg-white dark:bg-gray-700/80 text-gray-800 dark:text-gray-200 rounded-bl-none'}`}>
                        <div
                            className="whitespace-pre-wrap"
                            dangerouslySetInnerHTML={{ __html: parseSimpleMarkdown(message.text) }}
                        />
                    </div>
                    {!isUser && (
                        <div className="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <button
                                onClick={() => onSpeak(plainTextForSpeechAndCopy)}
                                className="p-1.5 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none"
                                aria-label="Read message aloud"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 17.142a5.001 5.001 0 010-7.072m2.828 9.9a9 9 0 010-12.728M12 12h.01" /></svg>
                            </button>
                            <button
                                onClick={() => onCopy(plainTextForSpeechAndCopy)}
                                className="p-1.5 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none"
                                aria-label="Copy message"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                            <button
                                onClick={() => onSummarize(message.text)}
                                className="p-1.5 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none"
                                aria-label="Summarize message"
                            >
                                <span className="font-bold text-xs">âœ¨</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        };
        
        const Toast = ({ message, show, onDismiss }) => {
            if (!show) return null;

            useEffect(() => {
                const timer = setTimeout(() => {
                    onDismiss();
                }, 3000); // Auto-dismiss after 3 seconds
                return () => clearTimeout(timer);
            }, [show, onDismiss]);

            return (
                <div className="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-up">
                    {message}
                </div>
            );
        };

        const ChatWindow = ({ messages, onSendMessage, language, onSpeak, isLoading, onClearChat, onCopy, onSummarize, onGetSuggestions, suggestions, showToast }) => {
            const [input, setInput] = useState('');
            const [isListening, setIsListening] = useState(false);
            const chatEndRef = useRef(null);
            const recognitionRef = useRef(null);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages, isLoading]);

            const handleSend = () => {
                if (input.trim()) {
                    onSendMessage(input.trim());
                    setInput('');
                }
            };

            const handleVoiceInput = useCallback(() => {
                if (isListening) {
                    recognitionRef.current?.stop();
                    setIsListening(false);
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    showToast("Sorry, your browser doesn't support speech recognition.");
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.lang = language;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognitionRef.current = recognition;

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    setIsListening(false);
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    setInput(prev => prev ? `${prev} ${speechResult}` : speechResult);
                };

                recognition.start();
            }, [isListening, language, showToast]);

            return (
                <div className="flex flex-col flex-grow">
                    <div className="flex-grow p-4 space-y-4 overflow-y-auto">
                        {messages.length > 1 && (
                            <div className="flex justify-center sticky top-2 z-10">
                                <button 
                                    onClick={onClearChat}
                                    className="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm text-xs text-gray-600 dark:text-gray-300 py-1 px-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200"
                                >
                                    Clear Chat
                                </button>
                            </div>
                        )}
                        {messages.map((msg, index) => (
                            <Message key={index} message={msg} onSpeak={onSpeak} onCopy={onCopy} onSummarize={onSummarize} />
                        ))}
                        {isLoading && <TypingIndicator />}
                        {!isLoading && messages.length > 2 && ( // Show only after some interaction
                            <div className="flex justify-center">
                                 <button onClick={onGetSuggestions} className="bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 text-sm font-medium py-2 px-4 rounded-full hover:bg-green-200 dark:hover:bg-green-800/80 transition-all duration-200 flex items-center gap-2">
                                     âœ¨ Smart Suggestions
                                 </button>
                            </div>
                        )}
                        {suggestions.length > 0 && (
                            <div className="flex flex-col items-center gap-2 py-2">
                                {suggestions.map((s, i) => (
                                    <button key={i} onClick={() => onSendMessage(s)} className="bg-gray-100 dark:bg-gray-800 w-full max-w-md text-left p-2.5 rounded-lg text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                        {s}
                                    </button>
                                ))}
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>
                    <div className="p-4 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700">
                        <div className="flex items-center space-x-2">
                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())}
                                placeholder="Type your message..."
                                className="flex-grow p-3 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none transition-all duration-300"
                                rows="1"
                            />
                            <button
                                onClick={handleVoiceInput}
                                className={`p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 focus:ring-green-500 transition-all duration-300 ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300'}`}
                                aria-label={isListening ? 'Stop listening' : 'Start voice input'}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                            <button
                                onClick={handleSend}
                                className="bg-green-500 text-white p-3 rounded-full hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 focus:ring-green-500 transition-transform duration-200 hover:scale-110"
                                aria-label="Send message"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
            const [language, setLanguage] = useState('en-IN');
            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [view, setView] = useState('home'); // 'home' or 'chat'
            const [suggestions, setSuggestions] = useState([]);
            const [toast, setToast] = useState({ show: false, message: '' });
            const chatHistoryRef = useRef([]);

            const getInitialMessage = () => ({
                role: 'model',
                text: 'Hello! I am GramGPT. I can help you with information on government schemes, farming, legal rights, and jobs. How can I assist you today?',
            });

            useEffect(() => {
                const initialBotMessage = getInitialMessage();
                setMessages([initialBotMessage]);
                chatHistoryRef.current = [{ role: 'user', parts: [{ text: "Initial Greeting" }] }, { role: 'model', parts: [{ text: initialBotMessage.text }] }];
            }, []);
            
            const showToast = (message) => {
                setToast({ show: true, message });
            };

            const dismissToast = () => {
                setToast({ show: false, message: '' });
            };

            // --- CHANGE 3: THE NEW, SMARTER handleCategorySelect FUNCTION ---
            const handleCategorySelect = (categoryTitle) => {
                setView('chat');

                // Extract the plain text topic from the title (e.g., "ðŸ¦ Government Schemes" -> "Government Schemes")
                const topic = categoryTitle.split(' ').slice(1).join(' ');

                // Generate a greeting based on language
                let greetingText = '';
                if (language === 'hi-IN') {
                    greetingText = `à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ ${topic} à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤†à¤ªà¤•à¥€ à¤®à¤¦à¤¦ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤à¥¤ à¤†à¤ª à¤•à¥à¤¯à¤¾ à¤œà¤¾à¤¨à¤¨à¤¾ à¤šà¤¾à¤¹à¥‡à¤‚à¤—à¥‡?`;
                } else {
                    greetingText = `Hi! I can help you with ${topic}. What would you like to know?`;
                }

                const initialBotMessage = getInitialMessage();
                const categoryGreetingMessage = { role: 'model', text: greetingText };

                // Set the chat window with the initial app greeting and the new category-specific one
                setMessages([initialBotMessage, categoryGreetingMessage]);
                
                // Update chat history to provide context to the AI for the user's NEXT message
                chatHistoryRef.current = [
                    { role: 'user', parts: [{ text: "Initial Greeting" }] }, 
                    { role: 'model', parts: [{ text: initialBotMessage.text }] },
                    // This next part is like a secret instruction to the AI
                    { role: 'model', parts: [{ text: `The user has selected the topic: ${topic}. I have greeted them accordingly and will now wait for their question.` }] }
                ];
            };
            
            const handleGoHome = () => {
                 setView('home');
            };

            const handleClearChat = () => {
                const initialBotMessage = getInitialMessage();
                setMessages([initialBotMessage]);
                setSuggestions([]);
                chatHistoryRef.current = [{ role: 'user', parts: [{ text: "Initial Greeting" }] }, { role: 'model', parts: [{ text: initialBotMessage.text }] }];
            };

            const handleCopy = (textToCopy) => {
                 navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast("Copied to clipboard!");
                 }).catch(err => {
                     console.error('Failed to copy text: ', err);
                     showToast("Failed to copy.");
                 });
            };
            
            const callGemini = async (payload) => {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                }
                return response.json();
            };

            const handleSummarize = async (textToSummarize) => {
                setIsLoading(true);
                const selectedLanguageName = LANGUAGES[language];
                const prompt = `Please summarize the following text in about one or two simple sentences, in the ${selectedLanguageName} language:\n\n---\n\n${textToSummarize}`;
                
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.5 }
                    };
                    const result = await callGemini(payload);
                    const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";
                    const summaryMessage = { role: 'model', text: `**Summary:** ${summaryText}` };
                    setMessages(prev => [...prev, summaryMessage]);
                } catch (error) {
                    console.error("Summarize API call failed:", error);
                    const errorMessage = { role: 'model', text: `Sorry, I couldn't summarize that. Please try again.` };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleGetSuggestions = async () => {
                setIsLoading(true);
                setSuggestions([]);
                const selectedLanguageName = LANGUAGES[language];
                const conversationContext = chatHistoryRef.current.map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n');
                const prompt = `Based on this conversation, suggest three relevant, short follow-up questions a user might ask. The user is speaking ${selectedLanguageName}, so provide the suggestions in that language. Return ONLY a JSON array of strings, like ["question 1", "question 2", "question 3"].\n\nConversation:\n${conversationContext}`;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { 
                            temperature: 0.8,
                            responseMimeType: "application/json",
                         }
                    };
                    const result = await callGemini(payload);
                    const suggestionsArray = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "[]");
                    setSuggestions(suggestionsArray);
                } catch (error) {
                    console.error("Suggestions API call failed:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSendMessage = async (userInput, isFromCategory = false) => {
                if (isLoading) return;
                setSuggestions([]);

                const userMessage = { role: 'user', text: userInput };
                
                setMessages(prev => [...prev, userMessage]);
                setIsLoading(true);

                const selectedLanguageName = LANGUAGES[language];
                const systemPrompt = `You are "GramGPT", an expert AI assistant for rural India. Your primary goal is to provide clear, concise, and actionable information.
                The user is communicating in ${selectedLanguageName}.
                You MUST respond fluently and accurately in ${selectedLanguageName}.
                Your knowledge base includes: Indian government schemes, modern agricultural practices, legal rights, job opportunities, **common pest/disease diagnosis for crops**, **step-by-step guides for applying for government documents**, and **fertilizer calculation estimates based on crop and area**.
                Keep your answers simple, easy to understand for a non-technical audience, and use bullet points or numbered lists for clarity where possible. Use markdown for formatting, for example **bold** for important terms.
                When providing pest/disease advice or fertilizer calculations, **always include a disclaimer** to consult local authorities or experts for confirmation.
                If you don't know an answer, say so honestly in ${selectedLanguageName} and suggest where they might find the information.
                Do not mention that you are a language model. Just be the helpful assistant, GramGPT.`;

                chatHistoryRef.current.push({ role: 'user', parts: [{ text: userInput }] });

                const payload = {
                    contents: chatHistoryRef.current,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.7, topK: 40, topP: 0.95 }
                };

                try {
                    const result = await callGemini(payload);
                    
                    let botResponseText = "Sorry, I couldn't get a response. Please try again.";
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]?.text) {
                        botResponseText = result.candidates[0].content.parts[0].text;
                    }

                    chatHistoryRef.current.push({ role: 'model', parts: [{ text: botResponseText }] });
                    const botMessage = { role: 'model', text: botResponseText };
                    
                    setMessages(prev => [...prev, botMessage]);

                } catch (error) {
                    console.error("Failed to fetch from Gemini API:", error);
                    const errorMessage = { role: 'model', text: `Sorry, something went wrong. Please check your connection and try again.` };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSpeak = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = language;
                    const voices = window.speechSynthesis.getVoices();
                    utterance.voice = voices.find(voice => voice.lang === language) || voices.find(voice => voice.lang.startsWith(language.split('-')[0])) || null;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                } else {
                    showToast("Sorry, your browser doesn't support text-to-speech.");
                }
            };
            
            useEffect(() => {
                 if ('speechSynthesis' in window) {
                     window.speechSynthesis.onvoiceschanged = () => {
                         window.speechSynthesis.getVoices();
                     };
                 }
            }, []);

            return (
                <div className="h-screen flex flex-col">
                    <Header 
                        theme={theme} 
                        setTheme={setTheme} 
                        language={language} 
                        setLanguage={setLanguage}
                        onHomeClick={handleGoHome}
                    />
                    <main className="flex-grow container mx-auto max-w-7xl w-full flex flex-col">
                        {view === 'home' && <HomePage onCategorySelect={handleCategorySelect} language={language} />}
                        {view === 'chat' && (
                            <ChatWindow 
                                messages={messages}
                                onSendMessage={handleSendMessage}
                                language={language}
                                onSpeak={handleSpeak}
                                isLoading={isLoading}
                                onClearChat={handleClearChat}
                                onCopy={handleCopy}
                                onSummarize={handleSummarize}
                                onGetSuggestions={handleGetSuggestions}
                                suggestions={suggestions}
                                showToast={showToast}
                            />
                        )}
                    </main>
                    <Footer />
                    <Toast message={toast.message} show={toast.show} onDismiss={dismissToast} />
                </div>
            );
        }

        // 5. Render the App to the 'root' div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
